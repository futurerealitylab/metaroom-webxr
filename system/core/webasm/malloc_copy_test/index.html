<!DOCTYPE html>
<!-- malloc_copy.html -->
<html>
  <head></head>
  <body>
    <script type="module">

      // very helpful tutorials:
      //
      // https://depth-first.com/articles/2019/10/16/compiling-c-to-webassembly-and-running-it-without-emscripten/
      //
      // https://aransentin.github.io/cwasm/
      //

      
      // allow use of async/await
      (async () => {
        try {
          const imports = {};

          const TOTAL_MEMORY   = 16777216;
          const WASM_PAGE_SIZE = 65536;

          // Build the WebAssembly instance.
          let memory = new WebAssembly.Memory({ 
            initial : TOTAL_MEMORY / WASM_PAGE_SIZE,
            maximum : TOTAL_MEMORY / WASM_PAGE_SIZE
          }); // old: 2
          // const response = await fetch('./library.wasm');
          // const bytes = await response.arrayBuffer();
          // const { instance } = await WebAssembly.instantiate(bytes, {
          //   env: { memory }
          // }); const wasm = {instance : instance};

          imports.memory = memory;
          imports.print_num = function(val) {
            console.log("Number received from WebASM: ", val);
            return val * 2;
          }

          const wasm = await WebAssembly.instantiateStreaming(
            fetch("./library.wasm"),
            {env : imports}
          );

          // Text to copy.
          const text = 'Hello from JavaScript!';

          // Configure shared memory.
          const view1 = new Uint8Array(memory.buffer);
          let inputPtr = wasm.instance.exports.malloc(1024);
          // malloc causes memory to grow, invalidating old view
          const view2 = new Uint8Array(memory.buffer);

          encode(view2, inputPtr, text);

          let outputPtr = wasm.instance.exports.malloc_copy(inputPtr, text.length);

          console.log('copy=[%s]', decode(view2, outputPtr));

          console.log("sin(180)=[%f]", wasm.instance.exports.my_sin(180.0));

          wasm.instance.exports.malloc_free(inputPtr);
          wasm.instance.exports.malloc_free(outputPtr);
          inputPtr = null;
          outputPtr = null;

        } catch (err) {
          console.error(err);
        }
        // Should free outputPtr and inputPtr
      })();

      // Encode string into memory starting at address baseAddr.
      const encode = (memory, baseAddr, string) => {
        for (let i = 0; i < string.length; i++) {
          memory[baseAddr + i] = string.charCodeAt(i);
        }

        memory[baseAddr + string.length] = 0;
      };

      // Decode a string from memory starting at address baseAddr.
      const decode = (memory, baseAddr) => {
        let cursor = baseAddr;
        let result = '';

        while (memory[cursor] !== 0) {
          result += String.fromCharCode(memory[cursor++]);
        }

        return result;
      };
    </script>
  </body>
</html>
